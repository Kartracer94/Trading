<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Trading Analyzer</title>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
  <div id="root"></div>
  
  <script type="text/babel">
    const { useState, useEffect } = React;

    const TradingApp = () => {
      const [data, setData] = useState([]);
      const [analysis, setAnalysis] = useState(null);
      const [ticker, setTicker] = useState('AAPL');
      const [loading, setLoading] = useState(false);
      const [error, setError] = useState(null);
      const [dataSource, setDataSource] = useState('demo');
      const API_KEY = '8sJBoZDCpg92UTI_7APnqoFRPWsIJ7oj';

      const fetchRealData = async (symbol) => {
        setLoading(true);
        setError(null);
        try {
          // Get date 50 days ago
          const toDate = new Date();
          const fromDate = new Date();
          fromDate.setDate(toDate.getDate() - 50);
          
          const fromStr = fromDate.toISOString().split('T')[0];
          const toStr = toDate.toISOString().split('T')[0];
          
          // Massive.com aggregates endpoint
          const url = `https://api.massive.com/v2/aggs/ticker/${symbol}/range/1/day/${fromStr}/${toStr}?apiKey=${API_KEY}`;
          
          const response = await fetch(url);
          
          if (!response.ok) {
            throw new Error('Failed to fetch data. Check if ticker is valid (e.g., AAPL, TSLA, MSFT)');
          }
          
          const result = await response.json();
          console.log('API Response:', result);
          
          if (!result.results || result.results.length === 0) {
            throw new Error('No data available for this ticker');
          }
          
          // Transform Massive.com data to our format
          const candles = result.results.map(bar => ({
            open: bar.o,
            high: bar.h,
            low: bar.l,
            close: bar.c,
            volume: bar.v || 0
          }));
          
          return candles;
        } catch (err) {
          setError(err.message);
          console.error('API Error:', err);
          return null;
        } finally {
          setLoading(false);
        }
      };

      const generateData = () => {
        const candles = [];
        let price = 45000;
        
        for (let i = 0; i < 50; i++) {
          const change = (Math.random() - 0.5) * 1000;
          const open = price;
          const close = price + change;
          const high = Math.max(open, close) + Math.random() * 200;
          const low = Math.min(open, close) - Math.random() * 200;
          const volume = Math.random() * 1000000 + 500000;
          
          candles.push({ open, high, low, close, volume });
          price = close;
        }
        return candles;
      };

      const calculateEMA = (prices, period) => {
        const k = 2 / (period + 1);
        let ema = prices[0];
        const result = [ema];
        
        for (let i = 1; i < prices.length; i++) {
          ema = prices[i] * k + ema * (1 - k);
          result.push(ema);
        }
        return result;
      };

      const calculateMACD = (candles) => {
        const closes = candles.map(c => c.close);
        const ema12 = calculateEMA(closes, 12);
        const ema26 = calculateEMA(closes, 26);
        const macdLine = ema12.map((val, i) => val - ema26[i]);
        const signal = calculateEMA(macdLine, 9);
        const histogram = macdLine.map((val, i) => val - signal[i]);
        
        return { macdLine, signal, histogram };
      };

      const detectCandlePattern = (candle) => {
        const body = Math.abs(candle.close - candle.open);
        const upperWick = candle.high - Math.max(candle.close, candle.open);
        const lowerWick = Math.min(candle.close, candle.open) - candle.low;
        const range = candle.high - candle.low;
        
        if (body < range * 0.1) {
          return { name: 'Doji', signal: 'NEUTRAL' };
        }
        
        if (candle.close > candle.open && lowerWick > body * 2 && upperWick < body * 0.3) {
          return { name: 'Hammer', signal: 'BULLISH' };
        }
        
        if (candle.close < candle.open && upperWick > body * 2 && lowerWick < body * 0.3) {
          return { name: 'Shooting Star', signal: 'BEARISH' };
        }
        
        if (candle.close > candle.open && body > range * 0.7) {
          return { name: 'Strong Bullish', signal: 'BULLISH' };
        }
        
        if (candle.close < candle.open && body > range * 0.7) {
          return { name: 'Strong Bearish', signal: 'BEARISH' };
        }
        
        return { name: 'No Pattern', signal: 'NEUTRAL' };
      };

      const findSupportResistance = (candles) => {
        const levels = [];
        
        for (let i = 5; i < candles.length - 5; i++) {
          const current = candles[i];
          const before = candles.slice(i - 5, i);
          const after = candles.slice(i + 1, i + 6);
          
          if (before.every(c => c.high <= current.high) && after.every(c => c.high <= current.high)) {
            levels.push({ price: current.high, type: 'resistance' });
          }
          
          if (before.every(c => c.low >= current.low) && after.every(c => c.low >= current.low)) {
            levels.push({ price: current.low, type: 'support' });
          }
        }
        
        return levels;
      };

      const analyzeData = (candles) => {
        const macd = calculateMACD(candles);
        const lastCandle = candles[candles.length - 1];
        const pattern = detectCandlePattern(lastCandle);
        const levels = findSupportResistance(candles);
        
        const avgVolume = candles.reduce((sum, c) => sum + c.volume, 0) / candles.length;
        const volumeSignal = lastCandle.volume > avgVolume * 1.2 ? 'HIGH' : 
                            lastCandle.volume < avgVolume * 0.8 ? 'LOW' : 'NORMAL';
        
        const lastMacd = macd.histogram[macd.histogram.length - 1];
        const prevMacd = macd.histogram[macd.histogram.length - 2];
        
        let macdSignal = 'NEUTRAL';
        if (lastMacd > 0 && prevMacd <= 0) macdSignal = 'BULLISH CROSS';
        else if (lastMacd < 0 && prevMacd >= 0) macdSignal = 'BEARISH CROSS';
        else if (lastMacd > 0) macdSignal = 'BULLISH';
        else if (lastMacd < 0) macdSignal = 'BEARISH';
        
        const currentPrice = lastCandle.close;
        const nearSupport = levels.filter(l => l.type === 'support' && l.price < currentPrice)
          .sort((a, b) => b.price - a.price)[0];
        const nearResistance = levels.filter(l => l.type === 'resistance' && l.price > currentPrice)
          .sort((a, b) => a.price - b.price)[0];
        
        let score = 0;
        const signals = [];
        
        if (macdSignal.includes('BULLISH')) {
          score += 2;
          signals.push({ name: 'MACD ' + macdSignal, type: 'BULLISH' });
        } else if (macdSignal.includes('BEARISH')) {
          score -= 2;
          signals.push({ name: 'MACD ' + macdSignal, type: 'BEARISH' });
        }
        
        if (pattern.signal === 'BULLISH') {
          score += 1;
          signals.push({ name: 'Pattern: ' + pattern.name, type: 'BULLISH' });
        } else if (pattern.signal === 'BEARISH') {
          score -= 1;
          signals.push({ name: 'Pattern: ' + pattern.name, type: 'BEARISH' });
        }
        
        if (volumeSignal === 'HIGH') {
          signals.push({ name: 'High Volume', type: 'NEUTRAL' });
        }
        
        if (nearSupport && (currentPrice - nearSupport.price) / currentPrice < 0.02) {
          score += 1;
          signals.push({ name: 'Near Support', type: 'BULLISH' });
        }
        
        if (nearResistance && (nearResistance.price - currentPrice) / currentPrice < 0.02) {
          score -= 1;
          signals.push({ name: 'Near Resistance', type: 'BEARISH' });
        }
        
        let overallSignal = 'NEUTRAL';
        if (score >= 3) overallSignal = 'STRONG BUY';
        else if (score >= 1) overallSignal = 'BUY';
        else if (score <= -3) overallSignal = 'STRONG SELL';
        else if (score <= -1) overallSignal = 'SELL';
        
        return {
          macdSignal,
          pattern,
          volumeSignal,
          nearSupport,
          nearResistance,
          currentPrice,
          overallSignal,
          score,
          signals,
          avgVolume: avgVolume.toFixed(0),
          currentVolume: lastCandle.volume.toFixed(0)
        };
      };

      useEffect(() => {
        const candles = generateData();
        setData(candles);
        setAnalysis(analyzeData(candles));
      }, []);

      const handleSearch = async () => {
        if (dataSource === 'real') {
          const candles = await fetchRealData(ticker);
          if (candles) {
            setData(candles);
            setAnalysis(analyzeData(candles));
          }
        } else {
          const candles = generateData();
          setData(candles);
          setAnalysis(analyzeData(candles));
        }
      };

      const refresh = () => {
        handleSearch();
      };

      if (!analysis) return <div className="p-8">Loading...</div>;

      const getColor = (signal) => {
        if (signal.includes('BUY')) return 'text-green-600';
        if (signal.includes('SELL')) return 'text-red-600';
        return 'text-gray-600';
      };

      const getBg = (signal) => {
        if (signal.includes('BUY')) return 'bg-green-100 border-green-300';
        if (signal.includes('SELL')) return 'bg-red-100 border-red-300';
        return 'bg-gray-100 border-gray-300';
      };

      return (
        <div className="min-h-screen bg-gray-50 p-6">
          <div className="max-w-6xl mx-auto">
            <div className="flex justify-between items-center mb-8">
              <h1 className="text-3xl font-bold">Trading Analyzer</h1>
              <button onClick={refresh} disabled={loading} className="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50">
                {loading ? 'Loading...' : 'Refresh'}
              </button>
            </div>

            <div className="bg-white p-6 rounded-lg shadow mb-8">
              <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">Data Source</label>
                  <select 
                    value={dataSource} 
                    onChange={(e) => setDataSource(e.target.value)}
                    className="w-full px-4 py-2 border border-gray-300 rounded-lg"
                  >
                    <option value="demo">Demo Data</option>
                    <option value="real">Real Market Data</option>
                  </select>
                </div>
                
                {dataSource === 'real' && (
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">Ticker Symbol</label>
                    <input
                      type="text"
                      value={ticker}
                      onChange={(e) => setTicker(e.target.value.toUpperCase())}
                      placeholder="AAPL, TSLA, MSFT..."
                      className="w-full px-4 py-2 border border-gray-300 rounded-lg"
                    />
                  </div>
                )}
                
                <div className="flex items-end">
                  <button 
                    onClick={handleSearch} 
                    disabled={loading}
                    className="w-full px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 disabled:opacity-50"
                  >
                    {loading ? 'Searching...' : 'Search'}
                  </button>
                </div>
              </div>
              
              {error && (
                <div className="mt-4 p-4 bg-red-100 border border-red-400 text-red-700 rounded">
                  <p className="font-bold">Error:</p>
                  <p>{error}</p>
                  <p className="text-sm mt-2">Try: AAPL, TSLA, MSFT, GOOGL, AMZN, NVDA</p>
                </div>
              )}
            </div>

            <div className={`p-8 rounded-lg shadow mb-8 border-2 ${getBg(analysis.overallSignal)}`}>
              <h2 className="text-xl font-semibold mb-2">Overall Signal {dataSource === 'real' ? `- ${ticker}` : '(Demo)'}</h2>
              <div className={`text-5xl font-bold ${getColor(analysis.overallSignal)}`}>
                {analysis.overallSignal}
              </div>
              <div className="text-gray-600 mt-2">Score: {analysis.score}</div>
              <div className="text-gray-800 mt-1 text-lg">Price: ${analysis.currentPrice.toFixed(2)}</div>
            </div>

            <div className="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
              <div className="bg-white p-6 rounded-lg shadow">
                <h3 className="text-xl font-semibold mb-4">MACD Analysis</h3>
                <div className="text-2xl font-bold text-blue-600 mb-2">{analysis.macdSignal}</div>
                <p className="text-gray-600">Moving Average Convergence Divergence indicator showing momentum</p>
              </div>

              <div className="bg-white p-6 rounded-lg shadow">
                <h3 className="text-xl font-semibold mb-4">Volume Analysis</h3>
                <div className="text-2xl font-bold text-purple-600 mb-2">{analysis.volumeSignal}</div>
                <div className="text-sm text-gray-600">Current: {analysis.currentVolume}</div>
                <div className="text-sm text-gray-600">Average: {analysis.avgVolume}</div>
              </div>

              <div className="bg-white p-6 rounded-lg shadow">
                <h3 className="text-xl font-semibold mb-4">Candlestick Pattern</h3>
                <div className="text-2xl font-bold text-orange-600 mb-2">{analysis.pattern.name}</div>
                <div className={`text-lg ${getColor(analysis.pattern.signal)}`}>{analysis.pattern.signal}</div>
              </div>

              <div className="bg-white p-6 rounded-lg shadow">
                <h3 className="text-xl font-semibold mb-4">Support & Resistance</h3>
                {analysis.nearResistance && (
                  <div className="mb-3">
                    <div className="text-sm text-gray-600">Resistance</div>
                    <div className="text-xl font-bold text-red-600">${analysis.nearResistance.price.toFixed(2)}</div>
                  </div>
                )}
                {analysis.nearSupport && (
                  <div>
                    <div className="text-sm text-gray-600">Support</div>
                    <div className="text-xl font-bold text-green-600">${analysis.nearSupport.price.toFixed(2)}</div>
                  </div>
                )}
              </div>
            </div>

            <div className="bg-white p-6 rounded-lg shadow">
              <h3 className="text-xl font-semibold mb-4">Active Signals</h3>
              <div className="space-y-2">
                {analysis.signals.map((sig, i) => (
                  <div key={i} className={`p-4 rounded ${
                    sig.type === 'BULLISH' ? 'bg-green-50 border border-green-200' :
                    sig.type === 'BEARISH' ? 'bg-red-50 border border-red-200' :
                    'bg-gray-50 border border-gray-200'
                  }`}>
                    <div className="flex justify-between items-center">
                      <span className="font-semibold">{sig.name}</span>
                      <span className={`px-3 py-1 rounded text-sm font-bold ${
                        sig.type === 'BULLISH' ? 'bg-green-600 text-white' :
                        sig.type === 'BEARISH' ? 'bg-red-600 text-white' :
                        'bg-gray-600 text-white'
                      }`}>
                        {sig.type}
                      </span>
                    </div>
                  </div>
                ))}
              </div>
            </div>

            <div className="mt-8 bg-white p-6 rounded-lg shadow">
              <h3 className="text-xl font-semibold mb-4">Recent Candles</h3>
              <div className="flex gap-2 overflow-x-auto">
                {data.slice(-20).map((candle, i) => {
                  const isGreen = candle.close > candle.open;
                  const bodyHeight = Math.abs(candle.close - candle.open);
                  const wickTop = candle.high - Math.max(candle.close, candle.open);
                  const wickBottom = Math.min(candle.close, candle.open) - candle.low;
                  const maxRange = Math.max(...data.slice(-20).map(c => c.high - c.low));
                  
                  return (
                    <div key={i} className="flex flex-col items-center" style={{minWidth: '20px'}}>
                      <div className="relative" style={{height: '100px', width: '12px'}}>
                        <div 
                          className={`absolute w-full ${isGreen ? 'bg-green-500' : 'bg-red-500'}`}
                          style={{
                            height: `${(bodyHeight / maxRange) * 80}px`,
                            bottom: `${((Math.min(candle.close, candle.open) - data.slice(-20).reduce((min, c) => Math.min(min, c.low), Infinity)) / maxRange) * 80}px`
                          }}
                        ></div>
                        <div 
                          className="absolute left-1/2 transform -translate-x-1/2 w-0.5 bg-gray-700"
                          style={{
                            height: `${(wickTop / maxRange) * 80}px`,
                            bottom: `${((Math.max(candle.close, candle.open) - data.slice(-20).reduce((min, c) => Math.min(min, c.low), Infinity)) / maxRange) * 80}px`
                          }}
                        ></div>
                        <div 
                          className="absolute left-1/2 transform -translate-x-1/2 w-0.5 bg-gray-700"
                          style={{
                            height: `${(wickBottom / maxRange) * 80}px`,
                            bottom: `${((candle.low - data.slice(-20).reduce((min, c) => Math.min(min, c.low), Infinity)) / maxRange) * 80}px`
                          }}
                        ></div>
                      </div>
                    </div>
                  );
                })}
              </div>
            </div>
          </div>
        </div>
      );
    };

    ReactDOM.render(<TradingApp />, document.getElementById('root'));
  </script>
</body>
</html>
